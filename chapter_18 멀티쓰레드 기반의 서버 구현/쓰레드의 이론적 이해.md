## 쓰레드의 이론적 이해

chapter 19 에서는 윈도우 기반에서의 쓰레드를 설명한다.

## 쓰레드 등장배경

앞서 Chapter 10에서는 멀티프로세스 기반의 서버구현에 대해 살펴보았다. 이때 보인 프로세스의 생성은 select 나 epoll 에 비해서 확실히 구분되는 장점이 있다. 그러나 나름의 문제점도 있다. 이전에 언급했던 것 처럼 일단 프로세스 생성이라는 작업자체가 운영체제 차원에서 상당히 부담되는 작업이다. 뿐만 아니라, 프로세스마다 완전히 독립된 메모리 공간을 유지하기 때문에 프로세스 사이에서 메시지를 주고받아야 하는 경우네는 그만큼 구현의 어려움을 겪기도 한다.

```
# 멀티프로세스 기반의 단점
1. 프로세스 생성이라는 부담스러운 작업과정
2. 두 프로세스 사이에서의 데이터 교환을 위해서는 별도의 IPC 기법을 적용해야 함
```

다음 단점도 있다.

"초당 적게는 수십 번에서 많게는 수천번까지 일어나는 '컨텍스트 스위칭(Context Switching)'에 따른 부담은 프로세스 생성방식의 가장 큰 부담이다."

CPU core 가 하나뿐인 시스템에서도 둘 이상의 프로세스가 동시에 실행되지 않은가? 이는 실행중인 둘 이상의 프로세스들이 CPU의 할당시간을 매우 작은 크기로 쪼개서 서로 나뉘기 때문에 가능한것 이다. 그런데 CPU의 할당시간을 나누기 위해서는 '컨텍스트 스위칭' 이라는 과정을 거쳐야 한다. 그럼 컨텍스트 스위칭이 무엇인지 알아보자

## 컨텍스트 스위칭

프로그램의 실행을 위해서는 해당 프로세스의 정보가 메인 메로리에 올라와야 한다. 때문에 현재 실행중인 A프로세스의 뒤를 이어서 B 프로세스를 실행시키려면 A 프로세스 관련 데이터를 메인 메로리에서 내리고 B프로세스 관련 데이터를 메인 메모리로 이동시켜야 한다. 그리고 바로 이것이 컨텍스트 스위칭이다. 그런데 이 때 A 프로세스 관련 데이터는 하드 디스크로 이동하기 때문에 컨텍스트 스위칭에는 오랜 시간이 걸린다.

결국 멀티프로세스의 특징을 유지하면서 단점을 어느 정도 극복하기 위해서 '쓰레드 (Thread)' 라는 것이 등장했는데, 이는 멀티프로세스의 여러가지 단점을 최소화 하기 위해서 설계된 일종의 '경량화 된 프로세스' 이다. 쓰레드는 다음의 장점을 가진다.

```
# 쓰레드의 장점
1. 쓰레드의 생성 및 컨텍스트 스위칭은 프로세스의 생성 및 컨텍스트 스위칭보다 빠르다.
2. 쓰레드 사이에서의 데이터 교환에는 특별한 기법이 필요치 않다.
```

이 두 가지 장점에 대해서는 서서히 이해하면 된다.

## 쓰레드와 프로세스의 차이점

쓰레드는 다음의 고민에 의해 등장했다.

"야! 둘 이상의 실행흐름을 갖기 위해서 프로세스가 유지하고 있는 메모리 영역을 통째로 복사한다는 것이 너무 부담스러워!"

프로세스의 메모리 구조는 전역변수가 할당되는 '데이터 영역', malloc 함수 등에 의해서 동적 할당이 이뤄지는 '힙(Heap)' 그리고 함수의 실행에 사용되는 '스택(stack)'으로 이뤄진다. 그런데 프로세스들은 이를 완전히 별도로 유지한다. 때문에 프로세스 사이에서는 다음의 메모리 구조를 보인다.

![alt text](/image/29.png)

그런데 둘 이상의 실행흐름을 갖는 것이 목적이라면 위 그림처럼 완전히 메모리 구조를 분리시킬 것이 아니라, 스택 영역만을 분리시킴으로써 다음의 장점을 얻을 수 있다.

```
1. 컨텍스트 스위칭 시 데이터 영역과 힙은 올리고 내릴 필요가 없다.
2. 데이터 영역과 힙을 이용해서 데이터를 교환할 수 있다.
```

그래서 등장한 것이 쓰레드 이며, 지금 설명한 것 처럼 모든 쓰레드는 별도의 실행흐름을 유지하기 위해서 스택영역만 독립적으로 유지하기 때문에 다음의 메모리 구조를 보인다.

![alt text](/image/30.png)

위 그림에서 보이듯이 데이터 영역과 힙을 공유하는 구조로 쓰레드는 설계되어 있다. 그리고 이를 위해서 쓰레드는 프로세스 내에서 생성 및 실행되는 구조로 완성되었다. 즉, 프로세스와 쓰레드는 다음과 같이 정의할 수 있다.

```
1. 프로세스 : 운영체제 관점에서 별도의 실행흐름을 구성하는 단위
2. 쓰레드 : 프로세스 관점에서 별도의 실행흐름을 구성하는 단위
```

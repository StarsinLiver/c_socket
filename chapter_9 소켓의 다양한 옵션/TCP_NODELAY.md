## TCP_NODELAY
Nagle 알고리즘에 대해 충분히 알아보자

## Nagle 알고리즘
Nagle 알고리즘은 네트워크 상에서 돌아다니는 패킷들의 흘러 넘침을 막기 위해서 1984년 제안된 알고리즘이다. 이는 TCP상에서 적용되는 매우 단순한 알고리즘으로써, 이의 적용여부에 따른 데이터 송수신 방식의 차이는 다음과 같다

![alt text](/image/image8.png)

위 그림은 문자열 "Nagle"을 Nagle 알고리즘을 적용해서 전송할 때와 적용하지 않고 전송할 대의 차이를 보여준다. 그리고 이를 통해서 다으므이 결론을 내릴 수 있다.

"Nagle 알고리즘은 앞서 전송한 데이터에 대한 ACK 메시지를 받아야만, 다음 데이터를 전송하는 알고리즘이다."

기본적으로 TCP 소켓은 Nagle 알고리즘을 적용해서 데이터를 송수신한다. 때문에 ACK가 수신될 때 가지 최대한 버퍼링을 해서 데이터를 전송한다. 위 그림의 왼편에서는 이러한 상황을 보여준다. 문자열 "Nagle" 의 전송을 위해 이를 출력 버퍼로 전달한다. 이 때 첫 문자 "N"이 들어온 시점에서는 이전에 전송한 패킷이 없으므로 (수신할 ACK가 없으므로) 바로 전송이 이뤄진다. 그리고 문자 "N"에 대한 ACK 가 기다리게 되는데, 기다리는 동안에 출력버퍼에는 문자열 나머지 "agle"이 채워진다.

이어서 문자 "N"에 대한 ACK를 수신하고 출력버퍼에 존재하는 데이터 "agle"을 하나의 패킷으로 구성해서 전송하게 된다. 즉 ,하나의 문자열 전송에 총 4개의 패킷이 송수신되었다.

그럼 이번에는 Nagle 알고리즘을 적용하지 않은 상태에서의 문자열 "Nagle" 전송에 대해 이야기 해보자. 문자 'N'에서 문자 'e'가지 순서대로 출력버퍼로 전달된다고 가정해보자. 이 상황에서 ACK의 수신에 상관없이 패킷의 전송이 이뤄지기 때문에 출력버퍼에 데이터가 전달되는 즉시 전송이 이뤄진다. 따라서 위 그림의 오른쪽에 보이듯이 문자열 "Nagle"의 전송에는 총 10개의 패킷이 송수신 될 수 있다. 이렇듯 Nagle 알고리즘을 적용하지 않으면 네트워크 트래픽 (Traffic : 네트워크에 걸리는 부하나 혼잡의 정도를 의미)에는 좋지 않은 영향을 미친다. 1바이트를 전송하더라도 패킷에 포함되어야 하는 헤더정보의 크기가 수십 바이트에 이르기 때문이다. 따라서 네트워크의 효율적인 사용을 위해서 Nagle 알고리즘은 반드시 적용해야 한다.

그러나 Nagle 알고리즘이 항상 좋은 것은 아니다. 전송하는 데이터의 특성에 따라서 Nagle 알고리즘의 적용 여부에 따른 트래픽의 차이가 크지 않으면서도 Nagle 알고리즘을 적용하는 것 보다 데이터의 전송이 빠른 경우도 있다. "용량이 큰 파일 데이터의 전송"이 대표적인 예이다. 파일 데이터를 출력버퍼로 밀어넣는 작업은 시간이 걸리지 않는다. 때문에 Nagle 알고리즘을 적용하지 않아도 출력버퍼를 거의 꽉 채운 상태에서 패킷을 전송하게 된다. 따럿 패킷의 수가 크게 증가하지도 않을 뿐더러 , ACK 를 기다리지 않고 연속해서 데이터를 전송하니 전송속도도 놀랍게 향상된다.

## 결론
일반적으로 Nagle 알고리즘을 적용하지 않으면 속도의 향상을 기대할 수 있으나, 무조건 Nagle 알고리즘을 적용하지 않을 경우에는 트래픽에 상당한 부담을 주게 되어 더 좋지 않은 결과를 얻을 수 있다. 따라서 데이터의 특성을 정확히 판단하지 않은 상태에서 Nagle 알고리즘을 중지하는 일을 없어야 한다.

## Nagle 알고리즘의 중단
바로 위에서 언급한 다음 상황에서까지 Nagle 알고리즘을 고집할 필요는 없다. 즉, 필요하다면 Nagle 알고리즘도 중단시켜야 한다.

"Nagle 알고리즘의 적용여부에 따른 트래픽의 차이가 크지 않으면서도 Nagle 알고리즘을 적용하는 것 보다 데이터의 전송이 빠른경우"

방법은 간단하다 아래의 코드에서 보이듯이 소켓옵션 TCP_NODELAY 를 1(TRUE)로 변경해주면 된다.

```c
int opt_val = 1;
setsockopt(sock , IPPROTO_TCP , TCP_NODELAY , (void*) &opt_val , sizeof(opt_val));
```

그리고 Nagle 알고리즘의 설정 상태를 확인하려면 다음과 같이 값을 확인할 수 있다.

```c
int opt_val;
socklen_t opt_len;
opt_len = sizeof(opt_val);

getsockopt(sock , IPPROTO_TCP , TCP_NODELAY , (void*) &opt_val , &opt_len);
```

Nagle 알고리즘이 설정된 상태라면 함수호출의 결과로 변수 opt_val 에는 0이 저장되며 반대로 설정되지 않은 상태라면 1이 저장된다.

